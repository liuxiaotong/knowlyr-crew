name: Deploy Engine

on:
  push:
    branches: [main]
  repository_dispatch:
    types: [knowlyr-gym-released]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Update engine & restart
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.DEPLOY_HOST }} '
            /opt/knowlyr-crew/venv/bin/pip install --force-reinstall --no-deps \
              "knowlyr-crew[webhook,execute,openai,id,trajectory] @ git+https://github.com/liuxiaotong/knowlyr-crew.git" \
            && systemctl restart knowlyr-crew \
            && sleep 2 \
            && curl -sf http://localhost:8765/health
          '

      - name: Upgrade trajectory packages
        if: github.event_name == 'repository_dispatch'
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.DEPLOY_HOST }} '
            /opt/knowlyr-crew/venv/bin/pip install --upgrade \
              --index-url https://pypi.org/simple/ \
              knowlyr-core knowlyr-sandbox knowlyr-recorder knowlyr-reward knowlyr-hub \
            && systemctl restart knowlyr-crew \
            && sleep 2 \
            && curl -sf http://localhost:8765/health
          '

      - uses: actions/checkout@v4
        with:
          sparse-checkout: |
            scripts
            static

      - name: Sync private repo (employee configs)
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.DEPLOY_HOST }} '
            cd /opt/knowlyr-crew/private-repo &&
            git pull --ff-only origin main
          '

      - name: Deploy scripts
        run: |
          scp -i ~/.ssh/deploy_key \
            scripts/audit_employees.py \
            scripts/daily_eval.py \
            scripts/run_daily_eval.sh \
            root@${{ secrets.DEPLOY_HOST }}:/opt/knowlyr-crew/project/scripts/

      - name: Deploy static assets & reload
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.DEPLOY_HOST }} \
            'mkdir -p /opt/knowlyr-crew/project/static/avatars'
          scp -i ~/.ssh/deploy_key \
            static/avatars/*.webp \
            root@${{ secrets.DEPLOY_HOST }}:/opt/knowlyr-crew/project/static/avatars/
          ssh -i ~/.ssh/deploy_key root@${{ secrets.DEPLOY_HOST }} '
            chmod +x /opt/knowlyr-crew/project/scripts/run_daily_eval.sh
            systemctl restart knowlyr-crew
            sleep 2
            curl -sf http://localhost:8765/health
          '

      - name: Install eval crontab
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.DEPLOY_HOST }} '
            crontab -l 2>/dev/null | grep -v 'run_daily_eval\.sh' > /tmp/_cron_clean || true
            echo "0 23 * * * /opt/knowlyr-crew/project/scripts/run_daily_eval.sh >> /var/log/knowlyr-crew-eval.log 2>&1" >> /tmp/_cron_clean
            crontab /tmp/_cron_clean
            rm -f /tmp/_cron_clean
          '

      - name: Audit employee config
        id: audit
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.DEPLOY_HOST }} '
            cd /opt/knowlyr-crew/project &&
            /opt/knowlyr-crew/venv/bin/python scripts/audit_employees.py --json
          '

      - name: Notify audit failure
        if: failure() && steps.audit.outcome == 'failure'
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.DEPLOY_HOST }} '
            curl -sf -X POST http://localhost:8765/run/employee/ceo-assistant \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${CREW_API_TOKEN}" \
              -d "{\"task\": \"部署后权限审计发现配置问题。请立即检查 GitHub Actions 日志（knowlyr-crew 仓库 Deploy Engine workflow），然后用 send_feishu_dm 通知 Kai 审计结果和需要修复的问题。\", \"format\": \"memo\"}"
          '

      - name: Trigger knowlyr-website rebuild
        run: |
          gh workflow run deploy.yml -R liuxiaotong/knowlyr-website
        env:
          GH_TOKEN: ${{ secrets.WEBSITE_DISPATCH_TOKEN }}
